{% extends "base.html" %}
{% load static %}
{% load score_color %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/application_detail.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> {% endblock %}

{% block content %}
<div class="ats-wrapper">
    
    <aside class="ats-sidebar">
        <div class="profile-card">
            <div class="avatar-placeholder">
                {{ app.full_name|make_list|first|upper }}
            </div>
            <h1 class="candidate-name">{{ app.full_name }}</h1>
            <p class="job-role">{{ app.job.title }}</p>
            
            <div class="status-workflow">
                <label class="section-label">Current Stage</label>
                <form method="POST" action="{% url 'hr_application_status' app.id %}">
                    {% csrf_token %}
                    <div class="select-wrapper">
                        <select name="status" class="status-dropdown {{ app.status }}" onchange="this.form.submit()">
                            <option value="screening" {% if app.status == 'screening' %}selected{% endif %}>Screening</option>
                            <option value="review"    {% if app.status == 'review' %}selected{% endif %}>Review</option>
                            <option value="interview" {% if app.status == 'interview' %}selected{% endif %}>Interview</option>
                            <option value="hired"     {% if app.status == 'hired' %}selected{% endif %}>Hired</option>
                            <option value="rejected"  {% if app.status == 'rejected' %}selected{% endif %}>Rejected</option>
                        </select>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                </form>
            </div>

            <div class="contact-info">
                <div class="info-row">
                    <i class="fas fa-envelope"></i>
                    <span>{{ app.email }}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-phone"></i>
                    <span>{{ app.phone }}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-calendar-alt"></i>
                    <span>{{ app.applied_at|date:"d M Y, h:i A" }}</span>
                </div>
            </div>

<div class="action-buttons">
    <a href="{{ app.resume_url }}"
       target="_blank"
       class="btn btn-primary">
        View Resume
    </a>

    <a href="{{ app.resume_url }}"
       download
       class="btn btn-secondary">
        Download Resume
    </a>
</div>


        </div>
    </aside>

    <main class="ats-main">

        <div class="main-header">
            <div>
                <h2>Application Analysis</h2>
            </div>
            <div class="fit-badge badge-{{ app.fit_category|lower }} {{ app.match_score|score_color }}">
                 {{ app.fit_category }} 
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-title">Total Match</div>
                <div class="stat-value {{ app.match_score|score_color }}">{{ app.match_score }}%</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Skills Match</div>
                <div class="stat-value">{{ app.skill_score }}%</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Exp. Match</div>
                <div class="stat-value">{{ app.experience_score }}%</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Keywords</div>
                <div class="stat-value">{{ app.keyword_score }}%</div>
            </div>
        </div>

        <div class="content-section ai-insights">
            <div class="section-header">
                <h3><i class="fas fa-clipboard-list"></i> Summary</h3>
            </div>
            <div class="insight-box">
                <h4>Executive Summary</h4>
                <p>{{ app.summary }}</p>
            </div>
            <div class="insight-box mt-3">
                <h4>Detailed Evaluation</h4>
                <p>{{ app.evaluation }}</p>
            </div>
        </div>

        <div class="content-section">
            <h3>Skills Breakdown</h3>
            <div class="table-responsive">
                <table class="ats-table">
                    <thead>
                        <tr>
                            <th>Required Skill</th>
                            <th>Status</th>
                            <th>Analysis</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for skill in app.job.required_skills %}
                            <tr>
                                <td class="fw-bold">{{ skill }}</td>
                                <td>
                                    {% if skill in app.matched_skills %}
                                        <span class="status-pill success"><i class="fas fa-check"></i> Found</span>
                                    {% else %}
                                        <span class="status-pill missing"><i class="fas fa-times"></i> Missing</span>
                                    {% endif %}
                                </td>
                                <td class="muted-text">
                                    {% if skill in app.matched_skills %}
                                        Detected in resume/projects
                                    {% else %}
                                        Not explicitly mentioned
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    <div class="content-section">
    <h3>Projects & Portfolio</h3>
    <div class="projects-block">
        {% if app.parsed_projects %}
            {{ app.parsed_projects|linebreaks }}
        {% else %}
            <p class="muted-text">No projects were identified in the resume.</p>
        {% endif %}
    </div>
</div>




<div class="content-section">
    <h3>Education</h3>
    <div class="projects-block">
        {% if app.parsed_education %}
            {{ app.parsed_education|linebreaks }}
        {% else %}
            <p class="muted-text">No education details were detected in the resume.</p>
        {% endif %}
    </div>
</div>

<div class="content-section">
    <h3>Certifications</h3>
    <div class="projects-block">
        {% if app.parsed_certifications %}
            {{ app.parsed_certifications|linebreaks }}
        {% else %}
            <p class="muted-text">No certifications found in the resume.</p>
        {% endif %}
    </div>
</div>



    </main>
</div>
{% endblock %}