{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}Smart ATS{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'css/theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/pages/sidebar.css' %}">

    <!-- Apply sidebar state BEFORE page renders -->
    <script>
        document.documentElement.classList.add(
            localStorage.getItem("sidebar_open") === "true" ? "sidebar-open" : "sidebar-closed"
        );
    </script>

    {% block extra_css %}{% endblock %}
</head>

<body>

{% if messages %}
    <div class="alert-container">
        {% for msg in messages %}
            <div class="alert 
                {% if 'success' in msg.tags %}alert-success
                {% elif 'error' in msg.tags %}alert-error
                {% elif 'warning' in msg.tags %}alert-warning
                {% else %}alert-info
                {% endif %}
            ">
                <span>{{ msg }}</span>
                <button class="alert-close">&times;</button>
            </div>
        {% endfor %}
    </div>
{% endif %}

    {% include "components/sidebar.html" %}

<!-- MAIN CONTENT -->
<div class="page-content">
    {% block content %}{% endblock %}
</div>

{% block extra_js %}{% endblock %}

<script>
/* CLOSE MESSAGE ALERT */
document.querySelectorAll('.alert-close').forEach(btn => {
    btn.addEventListener('click', () => {
        const box = btn.closest('.alert');
        box.classList.add('hide');
        box.addEventListener('transitionend', () => box.remove());
    });
});

/* SIDEBAR STATE USING LOCAL STORAGE */
document.addEventListener("DOMContentLoaded", () => {
    const menu = document.getElementById("sidebar");
    const toggle = document.getElementById("toggleSidebar");
    const content = document.querySelector(".page-content");

    if (!menu || !toggle) return;

    // Load saved state
    const savedState = localStorage.getItem("sidebar_open");
    if (savedState === "true") {
        menu.classList.add("open");
        content.classList.add("shift");
    }

    // Enable animation AFTER load
    setTimeout(() => document.body.classList.add("sidebar-ready"), 10);

    // Toggle sidebar
    toggle.addEventListener("click", () => {
        menu.classList.toggle("open");
        content.classList.toggle("shift");

        const isOpen = menu.classList.contains("open");
        localStorage.setItem("sidebar_open", isOpen);
    });
});

/* LOGOUT CONFIRMATION */
document.addEventListener("DOMContentLoaded", () => {
    const logoutBtn = document.getElementById("logoutConfirmBtn");
    const popup = document.getElementById("logoutPopup");
    const yesBtn = document.getElementById("logoutYes");
    const noBtn = document.getElementById("logoutNo");

    if (!logoutBtn) return;

    logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        popup.style.display = "flex";
    });

    noBtn.addEventListener("click", () => popup.style.display = "none");

    yesBtn.addEventListener("click", () => {
        window.location.href = "{% url 'logout_user' %}";
    });
});
</script>

</body>
</html>
